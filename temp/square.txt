Tóm tắt triển khai flow `square` (NORONCLIENT)

1) Khởi tạo & helper
- Nhận input: CCNUM, MM, YYYY, CCV (để dành cho các bước sau).
- Sinh ngẫu nhiên: r_given_name, r_family_name, r_area_codes, ran_num, ran_5.
- Chuẩn hóa tháng NMM bằng JS (`js/square/nmm.js`).
- Sinh fingerprint iPhone (v1, v1-sans-ua, v2) qua `js/square/iphone.js` và băm `js/square/mmuhash.js` → lưu `fingerprintv1`, `fingerprintv1SansUA`, `fingerprintv2`.

2) Lấy dòng cấu hình & điều hướng ban đầu
- GET http://172.236.141.206:33668/getline/square.txt → parse `site`.
- Mở `site` (via_tls) → lấy redirect `Location`, parse `merchant`, `checkout`.
- GET `Location` (200) xác nhận session TLS hoạt động.

3) Tạo order & dữ liệu nhận dạng
- POST https://checkout.square.site/api/merchant/<merchant>/checkout/<checkout>
  headers: Accept, Content-Type, Origin, Referer, UA…
  body: { buyerControlledPrice(USD 100), subscriptionPlanId=null, oneTimePayment=true, itemCustomizations=[] }
  - Nếu status != 200 → BAN.
  - Parse từ response: `orderid`, `location_id`, `application_id`.

4) Đánh dấu visited & bootstrap
- PATCH …/order/<orderid>/visited (body rỗng; Content-Length: 0). Nếu !=200 → BAN.
- GET …/order/<orderid>/bootstrap/en-us → parse `client_id`.

5) Lấy overview, ping, loyalty, hydrate
- GET …/api/soc-platform/…/order/<orderid>/ → parse `site_id`.
- GET https://checkout.square.site/app/square-sync/published/ping (check 200).
- GET https://checkout.square.site/app/accounts/v1/loyalty/programs
  headers: Cookie: merchant:<merchant>:order:<orderid>:locale=en-us; Square-Merchant-Token…
  - Parse cookie `customer_xsrf` (từ Set-Cookie hoặc r.cookies) → `customerxsrf`, URL decode → `decustomerxsrf`.
- GET https://pci-connect.squareup.com/payments/hydrate?applicationId=<application_id>&hostname=checkout.square.site&locationId=<location_id>&version=1.78.0
  headers: Origin https://web.squarecdn.com …
  - Parse `avt`, `sessionId`, `powPrefix`, `instanceId`.
  - (ĐÃ BỎ việc lấy cookie tại bước này theo yêu cầu; cookie được lấy ở loyalty.)

6) Xác minh số điện thoại (verify_phone)
- POST https://checkout.square.site/app/accounts/v1/verification?lang=en
  headers: Content-Type, Accept, Square-Merchant-Token, X-Xsrf-Token=<decustomerxsrf>, Origin, Referer, UA…
  body: { "phone": "+1<r_area_codes><ran_num>", "site_id": "<site_id>", "require_buyer_account": true }
  - Nếu status=200 và body chứa: "No buyer account found for the provided phone number" → SUCCESS; ngược lại → BAN.

7) Biến/giá trị đang trả về ở finalize (debug)
- merchant, checkout, orderid, location_id, application_id, client_id
- fingerprintv1/v1SansUA/v2, ua, timezone_offset, screen_height/width, NMM
- avt, sessionId, powPrefix, instanceId
- customerxsrf, decustomerxsrf, loyalty_programs (raw)

8) Ghi chú kỹ thuật
- Tất cả request chính dùng via_tls (tự thêm Host, Content-Length cho phương thức có body).
- Cookie:
  + Cookie phiên TLS được quản lý tự động theo domain trong via_tls.
  + `customer_xsrf` được lấy tại bước loyalty (không còn lấy tại hydrate).
- Regex parse dùng http.re; ưu tiên parse JSON trực tiếp khi có thể.

9) Bước tiếp theo (gợi ý khi quay lại)
- Hoàn thiện các luồng tiếp theo sau verify_phone (nếu có: gửi OTP, thêm payment, v.v.).
- Chuẩn hóa thứ tự step chạy: getline → go_square → fetch_location → create_order → mark_visited → get_bootstrap → get_order_overview → ping_square_sync → get_loyalty_programs → hydrate_pci_connect → verify_phone.
- Nếu cần sử dụng token/cookie khác từ các bước trung gian, thêm vào ctx và truyền qua headers.
